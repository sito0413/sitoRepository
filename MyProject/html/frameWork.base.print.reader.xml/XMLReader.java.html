<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>XMLReader.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">カバレッジ</a> &gt; <a href="index.source.html" class="el_package">frameWork.base.print.reader.xml</a> &gt; <span class="el_source">XMLReader.java</span></div><h1>XMLReader.java</h1><pre class="source lang-java linenums">package frameWork.base.print.reader.xml;

import static frameWork.base.print.reader.xml.UnitConversion.*;
import static frameWork.base.print.reader.xml.XMLConstants.*;

import java.awt.Dimension;
import java.io.File;
import java.io.IOException;
import java.net.URI;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentSkipListMap;

import javax.print.attribute.Size2DSyntax;
import javax.print.attribute.standard.MediaSize;
import javax.print.attribute.standard.OrientationRequested;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.xml.sax.SAXException;

import frameWork.base.print.ReportException;
import frameWork.base.print.element.BorderInfo;
import frameWork.base.print.element.Cell;
import frameWork.base.print.element.Page;
import frameWork.base.print.reader.Reader;

/**
 * 帳票レイアウトXMLファイル読込&lt;br&gt;
 */
<span class="nc" id="L32">public class XMLReader implements Reader {</span>
	/** 列(セル)幅算出係数 */
	private static final double WIDTH_COEFFICIENT = 1.0d;
	/** 行(セル)高さ算出係数 */
	private static final double HEIGHT_COEFFICIENT = 0.9d;
	
	@Override
	public final synchronized Page readSheet(final URI uri, final String sheetName) throws ReportException {
<span class="nc" id="L40">		final XMLBook book = read(uri);</span>
<span class="nc" id="L41">		final XMLSheet worksheet = book.worksheetsMap.get(sheetName);</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">		if (worksheet == null) {</span>
<span class="nc" id="L43">			throw new ReportException();</span>
		}
		
		// セル配置.
<span class="nc" id="L47">		return createPage(worksheet, book.stylesMap);</span>
		
	}
	
	private XMLBook read(final URI url) throws ReportException {
		try {
<span class="nc" id="L53">			return new XMLBook(DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(new File(url)));</span>
		}
<span class="nc" id="L55">		catch (SAXException | ParserConfigurationException | IOException e) {</span>
<span class="nc" id="L56">			throw new ReportException(&quot;XMLの読み込み処理に失敗しました&quot;, e);</span>
		}
	}
	
	// --------------------------------------------------
	
	//ページサイズ確認&lt;br&gt;
	private Dimension inquirePageSize(final XMLSheet worksheets) {
		// 定数定義.
<span class="nc" id="L65">		final int shortEdgeIndex = 0;</span>
<span class="nc" id="L66">		final int longEdgeIndex = 1;</span>
<span class="nc" id="L67">		final int unit = Size2DSyntax.MM;</span>
		// 用紙辺長さ取得.
<span class="nc" id="L69">		final MediaSize paperSize = MediaSize.getMediaSizeForName(worksheets.paperSize);</span>
<span class="nc" id="L70">		final float[] edgeLength = paperSize.getSize(unit);</span>
<span class="nc" id="L71">		final int shortEdge = getPaperEdgePixels(edgeLength[shortEdgeIndex], unit);</span>
<span class="nc" id="L72">		final int longEdge = getPaperEdgePixels(edgeLength[longEdgeIndex], unit);</span>
		// ページサイズ算出.
		int width;
		int height;
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (OrientationRequested.LANDSCAPE.equals(worksheets.orientation)) {</span>
<span class="nc" id="L77">			width = longEdge;</span>
<span class="nc" id="L78">			height = shortEdge;</span>
		}
		else {
<span class="nc" id="L81">			width = shortEdge;</span>
<span class="nc" id="L82">			height = longEdge;</span>
		}
		//
<span class="nc" id="L85">		return new Dimension(width, height);</span>
	}
	
	// 用紙の辺の長さをピクセル数で取得します&lt;br&gt;
	// 用紙サイズは拡大縮小率の影響を受けない.
	private static int getPaperEdgePixels(final double length, final int unit) {
<span class="nc bnc" id="L91" title="All 2 branches missed.">		return (int) Math.floor(unit == Size2DSyntax.MM ? millimetersToPixels(length) : inchesToPixels(length));</span>
	}
	
	// 用紙のマージンをピクセル数で取得します
	// 帳票レイアウト XML ファイルでのマージンは、.
	// インチ単位で記述されている.
	// 拡大縮小率によって変更される.
	private int getMarginPixels(final double length, final double scaleRate) {
<span class="nc" id="L99">		return (int) Math.ceil(inchesToPixels(length, scaleRate));</span>
	}
	
	// 印刷可能列確認&lt;br&gt;
	private Map&lt;Integer, XMLColumn&gt; inquirePrintableColumns(final XMLSheet worksheet, final Page pagePanel,
	        final double widthCoefficient) {
<span class="nc" id="L105">		final Map&lt;Integer, XMLColumn&gt; newColumnsMap = new ConcurrentSkipListMap&lt;&gt;();</span>
<span class="nc" id="L106">		int index = 0;</span>
<span class="nc" id="L107">		int totalWidth = 0;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		for (final XMLColumn column : worksheet.table.columns) {</span>
			// 列幅算出.
<span class="nc" id="L110">			final int width = getWidthPixels(column.width, widthCoefficient);</span>
			// 繰り返し列処理.
<span class="nc bnc" id="L112" title="All 2 branches missed.">			for (int i = -1; i &lt; column.span; i++) {</span>
				// 列インデックス更新.
<span class="nc" id="L114">				index++;</span>
				// 列情報追加.
<span class="nc" id="L116">				newColumnsMap.put(index, column);</span>
				// 幅確認.
<span class="nc" id="L118">				totalWidth += width;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">				if (totalWidth &gt;= pagePanel.getWidth()) {</span>
<span class="nc" id="L120">					break;</span>
				}
			}
			//
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (totalWidth &gt;= pagePanel.getWidth()) {</span>
<span class="nc" id="L125">				break;</span>
			}
<span class="nc" id="L127">		}</span>
		//
<span class="nc" id="L129">		return newColumnsMap;</span>
	}
	
	// 印刷可能行確認&lt;br&gt;
	private Map&lt;Integer, XMLRow&gt; inquirePrintableRows(final XMLSheet worksheet, final Page pagePanel,
	        final double heightCoefficient) {
<span class="nc" id="L135">		final Map&lt;Integer, XMLRow&gt; newRowsMap = new ConcurrentSkipListMap&lt;&gt;();</span>
<span class="nc" id="L136">		int index = 0;</span>
<span class="nc" id="L137">		int totalHeight = 0;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">		for (final XMLRow row : worksheet.table.rows) {</span>
			// 行高さ算出.
<span class="nc" id="L140">			final int height = getHeightPixels(row.height, heightCoefficient);</span>
			// 繰り返し処理.
<span class="nc bnc" id="L142" title="All 2 branches missed.">			for (int i = -1; i &lt; row.span; i++) {</span>
				// 行インデックス更新.
<span class="nc" id="L144">				index++;</span>
				// 行情報追加.
<span class="nc" id="L146">				newRowsMap.put(index, row);</span>
				// 高さ確認.
<span class="nc" id="L148">				totalHeight += height;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">				if (totalHeight &gt;= pagePanel.getHeight()) {</span>
<span class="nc" id="L150">					break;</span>
				}
			}
<span class="nc bnc" id="L153" title="All 2 branches missed.">			if (totalHeight &gt;= pagePanel.getHeight()) {</span>
<span class="nc" id="L154">				break;</span>
			}
<span class="nc" id="L156">		}</span>
<span class="nc" id="L157">		return newRowsMap;</span>
	}
	
	// ページコンテンツを生成します&lt;br&gt;
	private Page createPage(final XMLSheet worksheet, final Map&lt;String, XMLStyle&gt; styles) {
		// スケールの保持.
<span class="nc" id="L163">		final double scaleRate = worksheet.scale / 100d;</span>
<span class="nc" id="L164">		final double heightCoefficient = HEIGHT_COEFFICIENT * scaleRate;</span>
<span class="nc" id="L165">		final double widthCoefficient = WIDTH_COEFFICIENT * scaleRate;</span>
<span class="nc" id="L166">		final Dimension pageSize = inquirePageSize(worksheet);</span>
		
<span class="nc" id="L168">		final Page page = new Page(getMarginPixels(worksheet.leftMargin, scaleRate), getMarginPixels(</span>
		        worksheet.topMargin, scaleRate), getMarginPixels(worksheet.rightMargin, scaleRate), getMarginPixels(
		        worksheet.bottomMargin, scaleRate), pageSize.width, pageSize.height);
<span class="nc" id="L171">		final Map&lt;Integer, XMLColumn&gt; printableColumns = inquirePrintableColumns(worksheet, page, widthCoefficient);</span>
<span class="nc" id="L172">		final Map&lt;Integer, XMLRow&gt; printableRows = inquirePrintableRows(worksheet, page, heightCoefficient);</span>
		// セルパネル配置原点.
<span class="nc" id="L174">		int top = 0;</span>
<span class="nc" id="L175">		final int rowMax = printableRows.size();</span>
<span class="nc" id="L176">		final int colMax = printableColumns.size();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">		for (int rowIndex = 1; rowIndex &lt;= rowMax; rowIndex++) {</span>
<span class="nc" id="L178">			final XMLRow row = printableRows.get(rowIndex);</span>
<span class="nc" id="L179">			final int rowHeight = getHeightPixels(row.height, heightCoefficient);</span>
<span class="nc" id="L180">			int left = 0;</span>
			
<span class="nc bnc" id="L182" title="All 2 branches missed.">			for (int columnIndex = 1; columnIndex &lt;= colMax; columnIndex++) {</span>
<span class="nc" id="L183">				final XMLColumn column = printableColumns.get(columnIndex);</span>
<span class="nc" id="L184">				final int columnWidth = getWidthPixels(column.width, widthCoefficient);</span>
<span class="nc" id="L185">				final XMLCell cell = row.getCell(columnIndex);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">				if (cell != null) {</span>
					// セル情報あり.
					// セル幅算出.
<span class="nc" id="L189">					int width = columnWidth;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">					for (int i = 1; i &lt;= cell.mergeAccross; i++) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">						if ((columnIndex + i) &gt; printableColumns.size()) {</span>
<span class="nc" id="L192">							break;</span>
						}
<span class="nc" id="L194">						width += getWidthPixels(printableColumns.get(columnIndex + i).width, widthCoefficient);</span>
					}
					// セル高さ算出.
<span class="nc" id="L197">					int height = rowHeight;</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">					for (int i = 1; i &lt;= cell.mergeDown; i++) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">						if ((rowIndex + i) &gt; printableRows.size()) {</span>
<span class="nc" id="L200">							break;</span>
						}
<span class="nc" id="L202">						height += getHeightPixels(printableRows.get(rowIndex + i).height, heightCoefficient);</span>
					}
					// 属性取得 (セル → 行 → 列 → シート(標準) の順に検索).
<span class="nc" id="L205">					XMLStyle style = styles.get(cell.styleId);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">					if (style == null) {</span>
<span class="nc" id="L207">						style = styles.get(row.styleId);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">						if (style == null) {</span>
<span class="nc" id="L209">							style = styles.get(column.styleId);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">							if (style == null) {</span>
<span class="nc" id="L211">								style = styles.get(DEFAULTSTYLE_ID);</span>
							}
						}
					}
					// セルパネル生成.
<span class="nc" id="L216">					final List&lt;BorderInfo&gt; borderInfos = new ArrayList&lt;&gt;();</span>
					// 罫線追加.
<span class="nc bnc" id="L218" title="All 2 branches missed.">					for (final XMLBorder border : style.borders) {</span>
<span class="nc" id="L219">						borderInfos.add(new BorderInfo(border.linePosition, border.lineStyle, border.lineWeight));</span>
<span class="nc" id="L220">					}</span>
<span class="nc" id="L221">					page.addCell(new Cell(rowIndex - 1, columnIndex - 1, left, top, width, height, width, height,</span>
					        style.font, style.horizontalAlignment, style.verticalAlignment, cell.value, borderInfos,
					        scaleRate));
				}
				// レフト位置更新.
<span class="nc" id="L226">				left += columnWidth;</span>
			}
			// トップ位置更新.
<span class="nc" id="L229">			top += rowHeight;</span>
		}
<span class="nc" id="L231">		return page;</span>
	}
	
	// 帳票レイアウト XML ファイルでの列(セル)の幅は、.
	// ポイント数で記述されている.
	// 拡大縮小率によって変更される.
	private int getWidthPixels(final double width, final double widthCoefficient) {
<span class="nc" id="L238">		return (int) Math.floor(pointsToPixels(width, widthCoefficient));</span>
	}
	
	// 帳票レイアウト XML ファイルでの行(セル)の高さは、.
	// ポイント数で記述されている.
	// 拡大縮小率によって変更される.
	private int getHeightPixels(final double height, final double heightCoefficient) {
<span class="nc" id="L245">		return (int) Math.floor(pointsToPixels(height, heightCoefficient));</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>